# /nginx/nginx.conf
events {}

http {
    # ------------------------------------------------------------
    # EIN Reverse-Proxy, der drei interne Dienste erreichbar macht
    # ------------------------------------------------------------
    server {
        listen 80 default_server;
        server_name _;

        # ---------- FastAPI-Backend unter /api/ ----------
        location /api/ {
            rewrite ^/api/?(.*)$ /$1 break;
            proxy_pass http://backend:8000;

            proxy_set_header Host              $host;
            proxy_set_header X-Real-IP         $remote_addr;
            proxy_set_header X-Forwarded-For   $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }

        # ---------- Admin-SPA (gesch√ºtzt) -----------------
        location /admin {
            auth_basic              "Admin Area";
            auth_basic_user_file    /etc/nginx/.htpasswd;

            proxy_pass http://frontend:80/admin;

            proxy_set_header Host              $host;
            proxy_set_header X-Real-IP         $remote_addr;
            proxy_set_header X-Forwarded-For   $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }

        # ---------- Langfuse Dashboard --------------------
        location /langfuse/ {
            rewrite ^/langfuse/?(.*)$ /$1 break;
            proxy_pass http://langfuse:3000;

            proxy_set_header Host              $host;
            proxy_set_header X-Real-IP         $remote_addr;
            proxy_set_header X-Forwarded-For   $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }

        # ---------- Public SPA-Frontend -------------------
        location / {
            proxy_pass http://frontend:80;

            proxy_set_header Host              $host;
            proxy_set_header X-Real-IP         $remote_addr;
            proxy_set_header X-Forwarded-For   $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }
    }
}
